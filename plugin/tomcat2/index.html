<style>

    .plugin_body .box_conter {
        display: none;
    }

    .plugin_body .box_conter.active {
        display: block;
    }

    .tomcat_log {
        margin: 0px;
        width: 560px;
        height: 470px;
        background-color: #424251;
        overflow: auto;
        line-height: 22px;
        color: #fff;
        padding-left: 10px;
        font-family: arial;
        margin-top: 10px;
        outline: none;
    }
    .bt-form .bt_tab_list{
        border:1px solid #ccc;
        border-bottom: 0;
        background-color: #ececec;
    }
    .bt-form .bt_tab_list .bt_tab_index.active{
        background: #fff;
    }
    .bt_tab_index{
        display: inline-block;
        padding: 10px 25px;
        border-right: 1px solid #ccc;
        cursor: pointer;
        /* font-size: 14px; */
        color: #666;
    }
    .box_item{
        height: 150px;
        padding: 15px;
    }
    .box_item .status{
        height: 30px;
    }
    .btn_item_block{
        display: inline-block;
        margin-right: 50px;
    }
    .box_item .btn{
        margin-right: 15px;
    }
    .box_item .box_title{
        height: 35px;
        line-height: 35px;
        font-size: 14px;
        border-bottom: 1px solid #f0f0f1;
        margin-bottom: 15px;
    }
    .CodeMirror{
        height: 400px;
    }
    .box_table_conter{
        height: 350px;
        overflow-y: auto;
    }
    .tomcat_list .path,
    .tomcat_path_list .path{
        width: 150px;
    }
    .tomcat_list tr td span,
    .tomcat_path_list tr td i{
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-style: normal;
    }
    .select_list{
        width: 180px;
        height: 35px;
        line-height: 35px;
        border:1px solid #888;
        border-radius: 2px;
        display: inline-block;
        cursor: pointer;
        position: relative;
        margin-left: 15px;
        background: #fff url(data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAICAgICAgICAgIDAgICBAUEAgIEBQYFBQUFBQYHBgYGBgYGBwcICAkICAcKCgsLCgoODg4ODg4ODg4ODg4ODg7/2wBDAQMDAwYFBgsHBwsODAoMDhEQEBAQEREODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg7/wAARCAAHABQDAREAAhEBAxEB/8QAFgAAAwAAAAAAAAAAAAAAAAAABQcJ/8QAJBAAAQMCBAcAAAAAAAAAAAAAAQMEBQIRAAYHQRITITJRYXH/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Ar9nrS5SSnWj+E5bdOWVtJpmwCdVialaRvcAm3n70BywcKxy/GN4yPT4G7cd29R3qPs4AzgP/2Q==) no-repeat right center;
    }
    .select_list .select_item{
        width: 100%;
        display:block;
        /* text-align: center; */
        padding-left: 10px;
    }
    .select_list .select{
        width: 180px;
        position: absolute;
        left: -1px;
        top: 33px;
        border:1px solid #999;
        background: #fff;
    }
    .select_list .select li{
        height: 35px;
        line-height: 35px;
        padding:0 10px; 
    }
    .select_list .select li.active{
        background: #e6e6e6;
        /* cursor: no-drop; */
    }
    .select_list .select li:hover{
        background: #e6e6e6;
    }
    .install_version_box .btn-danger {
        color: #fff;
        background-color: #d9534f;
        border-color: #d43f3a;
    }
</style>
<div class="bt-form">
    <div class="bt-w-main">
        <!--菜单部分-->
        <div class="bt-w-menu">
            <p class="bgw">项目管理</p>
            <p>服务</p>
            <p>配置文件</p>
            <p>版本管理</p>
            <p>日志</p>
        </div>
        <!--内容部分-->
        <div class="bt-w-con pd15">
            <div class="plugin_body">
                <div class="box_conter active divtable">
                    <button class="btn btn-success btn-sm va0 mb15 add_tomcat">添加项目</button>
                    <div id="tomcat_fix" class="box_table_conter">
                        <table class="table table-hover">
                            <thead><tr><th>项目域名</th><th>项目路径</th><th>二级目录</th><th>Tomcat版本</th><th style="text-align: right;">操作</th></tr></thead>
                            <tbody class="tomcat_list"></tbody>
                        </table>
                    </div>
                    <ul class="help-info-text c7">
                        <li>默认项目是不能编辑操作的</li>
                        <li>项目映射之后可以直接通过域名访问</li>
                        <li>tomcat7、8、9 的默认端口依次是8081、8082、8083 </li>
                        <li>如果碰到问题可以发帖到此处<a href="https://www.bt.cn/bbs/thread-21974-1-1.html" target="_blank" class="btlink">查看详情</a></li>
                    </ul>
                </div>
                <div class="box_conter version_box ">
                    <div class="soft-man-con bt-form"></div>
                </div>
                <div class="box_conter config_box">
                    <div class="soft-man-con bt-form">
                        <p style="color: #666; margin-bottom: 7px">提示：Ctrl+F 搜索关键字，Ctrl+G 查找下一个，Ctrl+S 保存，Ctrl+Shift+R 查找替换!</p>
                        <div class="bt_tab_list"></div>
                        <textarea class="bt-input-text" style="height: 300px; line-height: 18px; display: none;" id="textBody"></textarea>
                        <button id="textBodyBtn" class="btn btn-success btn-sm" style="margin-top:10px;">保存</button>
                    </div>
                </div>
                <div class="box_conter install_version_box">
                    <span>Tomcat版本:</span><div class="select_list"><span class="select_item">Tomcat7 <i style="font-style: normal;color: #20a53a;">[ 已安装 ]</i></span>
                        <ul class="select" style="display:none"></ul>
                    </div>
                    <button class="btn btn-success btn-sm va0 mlr15 install_tomcat" style="display: none;">安装版本</button>
                    <button class="btn btn-danger btn-sm va0 mlr15 uninstall_tomcat" style="display: inline-block;">卸载版本</button>
                    <textarea class="install_log tomcat_log"></textarea>
                </div>
                <div class="box_conter">
                    <div style="margin-bottom:4px;"><span style="margin-right: 10px;">Tomcat版本:</span><select class="bt-input-text mr5 tomcat_version" name="tomcat_version" style="width:180px"></select></div>
                    <textarea class="tomcat_log"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>
<!--JS脚本部分，不要将JS脚本写在其它地方-->

<script>
    /**
     * 插件交互对象
     * 您的所有JS代码可以写在里面
     * 若不习惯JS的面向对象编程，可删除此对象，使用传统函数化的方式编写
     * */
    var tomcat = {
        plugin_name: 'tomcat2',
        logs_list:{},
        config_list:{},
        project_path:{},
        version_list:{},
        edit_codeMirror:'',
        layer_index:'',
        init: function () {
            var _this = this;
            $(".bt-w-menu p").click(function () {
                var j = 0;
                for(var i in _this.version_list){
                    if(!_this.version_list[i]) j++;
                }
                if(j === 3){
                    $('.bt-w-menu p:eq(3)').addClass('bgw').siblings().removeClass('bgw');
                    $('.bt-w-con .plugin_body .install_version_box').addClass('active').siblings().removeClass('active');
                    _this.create_tomcat_install_view();
                    layer.msg('未安装Tomcat服务',{icon:2});
                    return false;
                }
                var index = $(this).index();
                $('.plugin_body .box_conter').eq(index).addClass('active').siblings().removeClass('active');
                $(this).addClass('bgw').siblings().removeClass('bgw');
                switch (index) {
                    case 0:
                        _this.create_tomcat_list();
                    break;
                    case 1:
                        _this.create_server_version();
                    break;
                    case 2:
                        _this.create_config_edit();
                    break;
                    case 3:
                        _this.create_tomcat_install_view();
                    break;
                    case 4:
                        _this.create_logs_list();
                    break;
                }
            });
            $('#textBodyBtn').click(function(){
                var index = $('.bt_tab_index.active').attr('data-index');
                var data = _this.edit_codeMirror.getValue();
                var obj = {
                    data:data,
                    path:'/www/server/'+ _this.config_list.title[index] +'/conf/server.xml',
                    encoding:_this.config_list.data[index].encoding
                }
                _this.save_config_req(obj);
            });
            $('.add_tomcat').click(function(){
                tomcat.layer_index = layer.open({
                    type: 1,
                    closeBtn:2,
                    title:'添加Tomcat项目',
                    area: '470px', //宽高
                    content:'<div class="bt_conter bt-form pd15 pb70" style="height:200px;width:100%;">\
                                <div class="line"><span class="tname">项目版本</span>\
                                    <div class="info-r c4"><select class="bt-input-text mr5 project_version" name="version" style="width:270px"></select></div>\
                                </div>\
                                <div class="line"><span class="tname">项目域名</span>\
                                    <div class="info-r c4"><input class="bt-input-text" type="text" name="domain" placeholder="请输入项目域名" autocomplete="off" value="" style="width:270px"></div>\
                                </div>\
                                <div class="line"><span class="tname">项目路径</span>\
                                    <div class="info-r c4"><input class="bt-input-text" id="server_path" type="text" name="path" placeholder="请输入项目路径" value="/www/wwwroot" style="width:270px">\
                                    <span data-id="path" class="glyphicon cursor ml5 glyphicon-folder-open open_select_item" onclick="bt.select_path(&quot;server_path&quot;)"></span></div>\
                                </div>\
                                <ul class="help-info-text c7" style="padding-left: 29px;margin-top:5px;">\
                                    <li>项目版本:如需添加其他版本的Tomcat服务，请在<a href="javascript:tomcat.return_version();" class="btlink">版本管理</a>中安装</li>\
                                </ul>\
                            </div>',
                    btn: ['确定', '取消'],
                    success:function(layero, index){
                        var _html = '';
                        for(var i in _this.version_list){
                            if(_this.version_list[i]) _html += '<option value="'+ i +'">'+ i +'</option>';
                        }
                        $('.project_version').html(_html);
                        $('[name="domain"]').keyup(function(){
                            var val = $(this).val();
                            if($('[name="path"]').val().indexOf('/www/wwwroot') > -1){
                                $('[name="path"]').val('/www/wwwroot'+'/' +val);
                            }
                        });
                    },
                    yes:function(index, layero){
                        var domain = $('[name="domain"]').val();
                        var path = $('[name="path"]').val();
                        var version = $('[name="version"]').val();
                        if(domain == ''){
                            layer.msg('请输入项目域名',{icon:2});
                            return false;
                        }else if(path == ''){
                            layer.msg('请输入项目路径',{icon:2});
                            return false;
                        }else if(version == ''){
                            layer.msg('请输入项目版本',{icon:2});
                            return false;
                        }
                        _this.add_tomcat_req({domain:domain,path:path,version:version},function(res){
                            _this.create_tomcat_list(function(ress){
                                layer.msg(res.msg,{icon:res.status?1:2});
                                layer.close(index);
                            });
                        });
                    },
                    btn2:function(index, layero){
                        layer.close(index);
                    }
                });
            });
            $('.select_list').on('click','.select li',function(){
                $(this).addClass('active').siblings().removeClass('active');
                $('.select_list .select_item').html($(this).html());
                $('.select_list .select').hide();
                if($(this).html().indexOf('已安装') == -1){
                    $('.install_tomcat').show().next().hide();
                }else{
                    $('.uninstall_tomcat').show().prev().hide();
                }
            });
            $('.select_list .select_item').click(function (e) {
                e.stopPropagation();
                if($('.select_list .select').attr('style').indexOf('block') > -1){
                    $('.select_list .select').hide();
                }else{
                    $('.select_list .select').show();
                }
                $(document).click(function(e){
                    e.stopPropagation();
                    $('.select_list .select').hide();
                });
                // console.log($('.select_list .select').attr('style').indexOf('block'))
            });
            $('.install_version_box').on('click','.install_tomcat',function(){
                var active_val = $('.select .active').attr('data-value');
                layer.closeAll('dialog');
                _this.create_tomcat_install({version:active_val,type:'install' });
            });
            $('.install_version_box').on('click','.uninstall_tomcat',function(){
                var active_val = $('.select .active').attr('data-value');
                layer.closeAll('dialog');
                layer.confirm('是否卸载【'+ active_val +'】程序',{title:'卸载Tomcat',icon:0,closeBtn: 2,shift: 5},function(){
                    _this.create_tomcat_install({version:active_val,type:'uninstall'});
                });
            });
            _this.get_server_version(function(res){
                var rdata = res.msg,j = 0;
                _this.version_list = rdata
                for(var i in _this.version_list){
                    if(!_this.version_list[i]) j++;
                }
                if(j === 3){
                    $('.bt-w-menu p:eq(3)').click();
                    _this.create_tomcat_install_view();
                    layer.msg('未安装Tomcat服务',{icon:2});
                    return false;
                }
                _this.create_tomcat_list();
            });
            _this.scorll_table('tomcat_fix');
        },
        return_version:function(){
            $('.bt-w-menu p:eq(3)').click();
            layer.close(this.layer_index);
        },
        // 表格滑动
        scorll_table:function(id){
            var tableName = document.querySelector('#' + id);
            tableName.addEventListener('scroll', function(e){
                var scrollTop = this.scrollTop;
                $(this).find("thead").css({ "transform": "translateY(" + scrollTop + "px)", "position": "relative", "z-index": "1" });
            })
        },
        // 创建tomcat安装视图
        create_tomcat_install_view:function(callback){
            var _this = this;
            this.get_server_version(function(res){
                var _html = '';
                _this.version_list = res.msg;
                for(var i in _this.version_list){
                    _html+='<li data-value="'+ i +'">'+ i +'&nbsp;<i style="font-style: normal;'+ (!_this.version_list[i]?'':'color: #20a53a;') +'">[ '+ (_this.version_list[i]?'已安装':'未安装')+' ]</i></li>'
                }
                $('.select_list .select').html(_html);
                var _index = $('.select_list .select li').eq(0).html();
                $('.select_item').html(_index);
                $('.select_list .select li').eq(0).addClass('active');
                if(_index.indexOf('未安装') > -1){
                    $('.install_tomcat').show().next().hide();
                }else{
                    $('.uninstall_tomcat').show().prev().hide();
                }
                if(callback) callback(res)
            });
            this.get_install_log(function(res) {
                $('.tomcat_log').text(res.msg);
                var ele = document.getElementsByClassName('install_log')[0];
                 ele.scrollTop = ele.scrollHeight;
            });
        },
        // 创建tomcat安装
        create_tomcat_install:function(obj,callback){
            var _this = this;
            var active_val = $('.select .active').attr('data-value');
                layer.closeAll('dialog');
                $(obj.type == 'install'?'.install_tomcat':'.uninstall_tomcat').html((obj.type == 'install'?'正在安装':'正在卸载')).attr('disabled','disabled');
                this.send({
                    method:'InstallTomcat',
                    tips:(obj.type == 'install'?'正在安装':'正在卸载') +'【'+ obj.version +'】'+'服务，请耐心等待&nbsp;<img src="/static/img/ing.gif">',
                    data:{type:obj.type,version:obj.version},
                    success:function(res){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        if(!res.status) return false
                        if(callback) callback(res);
                        $('.install_version_box '+ (obj.type == 'install'?'.btn-success':'.btn-danger')).html(obj.type == 'install'?'安装版本':'卸载版本').removeAttr('disabled')
                        var loadT = layer.msg('正在获取版本信息，请稍后...');
                        _this.create_tomcat_install_view(function(){
                            layer.close(loadT);
                            layer.msg(res.msg,{icon:1});
                        });
                        clearInterval(get_log);
                    }
                })
                var get_log = setInterval(function(){
                    _this.get_install_log(function(res){
                        var ele = document.getElementsByClassName('install_log')[0];
                        ele.scrollTop = ele.scrollHeight;
                    });
                },1000)
        },
        // 获取安装日志
        get_install_log:function(callback){
            this.send({
                method:'GetSetLog',
                load:2,
                success:function(res){
                    if(!res.status){
                        layer.msg(res.msg,{icon:2});
                        return false
                    } 
                    if(callback) callback(res)
                }
            })
        },
        // 创建tomcat列表
        create_tomcat_list:function(callback){
            var _html = '';
            this.get_tomcat_site(function(res){
                var rdata = res.msg;
                for(var i in rdata){
                    for(var j = 0; j < rdata[i].length - 1;j++){
                        rdata[i][j].version = rdata[i][rdata[i].length -1];
                        rdata[i][j].types = i;
                        _html += '<tr><td>'+ rdata[i][j].name +'</td><td><a href="javascript:openPath(\''+ (rdata[i][j].appBase == 'webapps'?'/www/server/'+ rdata[i][j].types +'/webapps':rdata[i][j].appBase) +'\');" class="btlink"><span class="path" title="'+ (rdata[i][j].appBase == 'webapps'?'/www/server/'+ rdata[i][j].types +'/webapps':rdata[i][j].appBase) +'">'+ (rdata[i][j].appBase == 'webapps'?'/www/server/'+ rdata[i][j].types +'/webapps':rdata[i][j].appBase) +'</span></a></td>\
                            <td><a href="javascript:;" class="btlink" onclick="tomcat.create_tomcat_path({version:\''+ rdata[i][j].types +'\',domain:\''+ rdata[i][j].name +'\'})">管理</a></td>\
                            <td>'+ rdata[i][j].version  +'</td>\
                            <td style="text-align: right;">'+
                            '<a href="javascript:;" class="btlink" onclick="tomcat.set_mapping_req({version:\''+ rdata[i][j].types +'\',domain:\''+ rdata[i][j].name +'\'})">映射</a>&nbsp;&nbsp;|&nbsp;&nbsp;'+
                            '<a href="javascript:;" class="btlink" onclick="tomcat.set_tomcat_view({version:\''+ rdata[i][j].types +'\',domain:\''+ rdata[i][j].name +'\',path:\''+ rdata[i][j].appBase +'\'})">编辑</a>&nbsp;&nbsp;|&nbsp;&nbsp;'+
                            '<a href="javascript:;" class="btlink" onclick="tomcat.del_tomcat_req({version:\''+ rdata[i][j].types +'\',domain:\''+ rdata[i][j].name +'\'})">删除</a></td></tr>'
                    }
                }
                $('.box_table_conter .tomcat_list').html(_html);
                if(callback) callback(res);
            });
        },
        // 创建tomcat列表
        create_tomcat_path:function(obj,callback,type){
            var _this = this;
            if(obj.domain == 'localhost'){
                layer.msg('默认项目不支持二级目录添加',{icon:2});
                return false;
            }
            this.get_tomcat_path({
                version:obj.version,
                domain:obj.domain
            },function (res) {
                var rdata = res.msg,_html = '';
                for(var i = 0; i < rdata.length;i++){
                    _html += '<tr>'+
                                '<td><i class="path" title="'+ rdata[i].path +'">'+ rdata[i].path +'</i></td>'+
                                '<td><i class="path" style="width: 100px;" title="'+ rdata[i].docBase +'">'+ rdata[i].docBase +'</i></td>'+
                                '<td style="text-align: right;"><a href="javascript:;" class="btlink" onclick="tomcat.del_tomcat_path({domain:\''+ obj.domain +'\',version:\''+ obj.version +'\',path:\''+ rdata[i].path +'\'})">删除</a></td></tr>'
                }
                if(!type){
                    layer.open({
                        type: 1,
                        closeBtn:2,
                        title:'【'+ obj.domain +'】二级目录',
                        area: '400px', //宽高
                        content:'<div class="bt_conter divtable bt-form pd15" id="tomcat_path" style="height:400px;width:100%;">\
                                    <button class="btn btn-success btn-sm va0 mb15 add_path">添加二级目录</button>\
                                    <table class="table table-hover">\
                                        <thead><tr><th>项目路径</th><th>访问路径</th><th style="text-align: right;">操作</th></tr></thead>\
                                        <tbody class="tomcat_path_list">'+ _html +'</tbody>\
                                    </table>\
                                </div>',
                        success:function(index,layero){
                            _this.scorll_table('tomcat_path');
                            $('.add_path').click(function(){
                                layer.open({
                                    type: 1,
                                    closeBtn:2,
                                    title:'添加二级目录',
                                    area: '400px', //宽高
                                    content:'<div class="bt_conter divtable bt-form pd15" style="height:120px;width:100%;">\
                                                <div  class="line"><span class="tname">二级目录</span>\
                                                    <div class="info-r c4"><input class="bt-input-text" id="server_path" type="text" name="path" placeholder="请输入二级目录" value="" style="width:220px"><span data-id="path" class="glyphicon cursor pl7 glyphicon-folder-open open_select_item" onclick="bt.select_path(&quot;server_path&quot;)"></span></div>\
                                                </div>\
                                                <div class="line"><span class="tname">访问路径</span>\
                                                    <div class="info-r c4"><input class="bt-input-text" type="text" name="name" placeholder="请输入访问路径" value="" style="width:220px"></div>\
                                                </div>\
                                            </div>',
                                    btn:['确定','取消'],
                                    yes:function(index,layero){
                                        var path = $('[name="path"]').val(),name = $('[name="name"]').val();
                                        if(path == ''){
                                            layer.msg('二级目录不能空',{icon:2});
                                            return false;
                                        }else if(name == ''){
                                            layer.msg('访问路径不能为空',{icon:2});
                                            return false;
                                        }
                                        _this.add_tomcat_path({
                                            version:obj.version,
                                            domain:obj.domain,
                                            path:path,
                                            name:name
                                        },function(res){
                                            _this.create_tomcat_path(obj,function(ress){
                                                layer.msg(res.msg,{icon:1});
                                            },true);
                                            layer.close(index);
                                        });
                                    },
                                    btn2:function(index,layero){
                                        layer.close(index);
                                    }
                                })
                            });
                        }
                    });
                }else{
                    $('.tomcat_path_list').html(_html);
                }
                if(callback) callback(res);
            });
        },
        // 删除二级目录
        del_tomcat_path:function(obj){
            var _this = this;
            layer.confirm('是否删除【'+ obj.path +'】二级目录',{title:'删除二级目录',icon:0,closeBtn: 2,shift: 5},function(){
                _this.send({
                    method:'DelSitePath',
                    data:{version:obj.version,domain:obj.domain,path:obj.path},
                    timeout:9999999,
                    tips:'正在删除二级目录，请稍后...',
                    success:function(res){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        if(!res.status){
                            return false
                        }else{
                            _this.create_tomcat_path({
                                version:obj.version,
                                domain:obj.domain
                            },function(ress){
                                layer.msg(res.msg,{icon:1});
                            },true);
                        }
                    }
                });
            });
        },
        // 添加Tomcat二级目录
        add_tomcat_path:function(obj,callback){
            this.send({
                method:'AddSitePath',
                tips:'正在添加二级目录,请稍后...',
                data:{
                    version:obj.version,
                    domain:obj.domain,
                    path:obj.path,
                    name2:obj.name
                },
                timeout:9999999,
                success:function(res){
                    layer.msg(res.msg,{icon:res.status?1:2});
                    if(!res.status){
                        return false;
                    }
                    if(callback) callback(res);
                }
            });
        },
        // 获取Tomcat二级目录
        get_tomcat_path:function(obj,callback){
            this.send({
                method:'GeterPath',
                tips:'正在获取二级目录,请稍后...',
                data:{version:obj.version,domain:obj.domain},
                timeout:9999999,
                success:function(res){
                    if(!res.status){
                        layer.msg(res.msg,{icon:2});
                        return false
                    }
                    if(callback) callback(res);
                }
            });
        },
        // 状态reloadable路径
        status_reloadable_path:function(obj,callback){
            var _this = this;
            layer.confirm(obj.reloadable == '0'?'是否关闭Reloadable属性':'是否启动Reloadable属性',{title:'设置Reloadable属性',icon:0,closeBtn: 2,shift: 5},function(){
                _this.send({
                    method:'Reloadable2',
                    tips:obj.reloadable == '0'?'关闭Reloadable属性中，请稍后...':'启动Reloadable属性中，请稍后...',
                    data:{version:obj.version,domain:obj.domain,reloadable:obj.reloadable},
                    timeout:9999999,
                    success:function(res){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        if(!res.status){
                            layer.msg(res.msg,{icon:2});
                            return false
                        }
                        _this.create_tomcat_path(obj,function(ress){
                            layer.msg(res.msg,{icon:1});
                        },true);
                        if(callback) callback(res);
                    }
                });
            });
        },
        // tomcat状态请求
        start_tomcat:function(obj){
            var objs = {},_this = this;
            switch(obj.type){
                case 'stop':
                    objs = {title:'停止服务【'+ obj.version +'】',msg:'是否停止【'+ obj.version +'】服务',tips:'正在停止【'+ obj.version +'】服务，请稍后<img src="/static/img/ing.gif">'}
                break;
                case 'start':
                    objs = {title:'启动服务【'+ obj.version +'】',msg:'是否启动【'+ obj.version +'】服务',tips:'正在启动【'+ obj.version +'】服务，请稍后<img src="/static/img/ing.gif">'}
                break;
                case 'reload':
                    objs = {title:'重载服务【'+ obj.version +'】',msg:'是否重载【'+ obj.version +'】服务',tips:'正在重载【'+ obj.version +'】服务，请稍后<img src="/static/img/ing.gif">'}
                break;
            }
            layer.confirm(objs.msg,{title:objs.title,icon:0,closeBtn: 2,shift: 5},function(){
                _this.send({
                    method:'StartTomcat',
                    tips:objs.tips,
                    data:{
                        version:obj.version,
                        type:obj.type 
                    },
                    success:function(res){
                        setTimeout(function(){
                            layer.msg(res.msg,{icon:res.status?1:2});
                        },500)
                        _this.create_server_version();
                    }
                });
            });
        },

        // 获取端口请求
        get_port_req:function(obj,callback){
            this.send({
                method:'GetTomcatPort',
                data:{version:obj.version},
                tips:'正在获取端口，请稍后...',
                success:function(res){
                    if(!res.status){
                        layer.msg(res.msg,{icon:2});
                        return false;
                    }
                    if(callback) callback(res);
                }
            });
        },
        // 设置端口请求
        set_port_req:function(obj,callback){
            this.send({
                method:'SetTomcatPort',
                data:{version:obj.version,port:obj.port},
                tips:'正在设置端口,请稍后...',
                timeout:999999,
                success:function(res){
                    layer.msg(res.msg,{icon:res.status?1:2});
                    if(!res.status) return false;
                    if(callback) callback(res);
                }
            })
        },
        
        
        // 获取映射请求
        get_mapping_req:function(obj,callback){
            this.send({
                method:'GetProxy',
                data:{sitename:obj.sitename},
                tips:'获取映射状态,请稍后...',
                success:function(res){
                    if(!res.status){
                        layer.msg(res.msg,{icon:2});
                        return false;
                    }
                    if(callback) callback(res);
                }
            });
        },
        // 设置映射请求
        set_mapping_req:function(obj,callback){
            var _this = this;
            if(obj.domain == 'localhost'){
                layer.msg('默认项目不支持映射',{icon:2});
                return false;
            }
            layer.confirm('是否映射【'+ obj.domain +'】项目',{title:'映射项目',icon:0,closeBtn: 2,shift: 5},function(){
                _this.send({
                    method:'Mapping',
                    tips:'正在设置映射中,请稍后...',
                    data:{version:obj.version,domain:obj.domain},
                    success:function(res){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        if(!res.status) return false;
                        if(callback) callback(res);
                    }
                });
            });
        },
        
        // 获取Reloadable请求
        get_reloadable_req:function(obj,callback){
            this.send({
                method:'GetReloadable',
                data:{version:obj.version,domain:obj.domain},
                tips:'正在获取Reloadable状态,请稍后...',
                success:function(res){
                    if(!res.status){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        return false;
                    }
                    if(callback) callback(res);
                }
            })
        },
        // 设置Reloadable请求
        set_reloadable_req:function(obj,callback){
            this.send({
                method:'Reloadable2',
                data:{version:obj.version,domain:obj.domain,reloadable:obj.reloadable},
                tips:'正在设置Reloadable状态,请稍后...',
                success:function(res){
                    if(!res.status){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        return false;
                    }
                    if(callback) callback(res);
                }
            })
        },


        // 设置Tomcat视图
        set_tomcat_view:function(obj){
            var _this = this;
            if(obj.domain == 'localhost'){
                layer.msg('默认项目不支持编辑',{icon:2});
                return false;
            }
            layer.open({
                type: 1,
                closeBtn:2,
                title:'修改【'+ obj.domain +'】项目',
                area: '430px', //宽高
                btn:['保存','取消'],
                content:'<div class="bt_conter bt-form pd30" style="height:180px;width:100%;">\
                        <div class="line"><span class="tname">项目域名</span>\
                            <div class="info-r c4"><input class="bt-input-text" type="text" name="domain" placeholder="请输入项目域名" value="'+ obj.domain +'" style="width:220px;"></div>\
                        </div>\
                        <div class="line"><span class="tname">项目路径</span>\
                            <div class="info-r c4"><input class="bt-input-text" id="server_path" type="text" name="path" placeholder="请输入项目路径" value="'+ obj.path +'" style="width:220px;margin-right:5px;"><span data-id="path" class="glyphicon cursor ml5 glyphicon-folder-open open_select_item" onclick="bt.select_path(&quot;server_path&quot;)"></span></div>\
                        </div>\
                        <div class="line"><span class="tname">项目映射</span>\
                            <div class="info-r c4" style="padding-top: 5px;">\
                                <input class="btswitch btswitch-ios" id="terclose" name="mapping" type="checkbox">\
                                <label class="btswitch-btn" for="terclose"></label>\
                            </div>\
                        </div>\
                    </div>',
                success:function(){
                    this
                },
                yes:function(index,layero){
                    var  domain2 = $('[name="domain"]').val();
                    var  path = $('[name="path"]').val();
                    var  mapping = $('[name="mapping"]').prop("checked");
                    var type = '',type1 = '';
                    if(obj.path != path){
                        _this.set_path_req({
                            domain:obj.domain,
                            path:path,
                            version:obj.version
                        },function(res){
                            layer.close(index);
                            if(obj.path != path){
                                _this.create_tomcat_list(function(){
                                    layer.msg('修改完成',{icon:1});
                                });
                            }
                        });
                        type = false;
                    }else{
                        type = true;
                    }
                    if(obj.domain != domain2){
                        _this.set_domain_req({
                            domain:obj.domain,
                            domain2:domain2,
                            appbase:path,
                            mapping:mapping?1:0,
                            version:obj.version,
                        },function (res){
                            layer.close(index);
                            if(obj.domain != domain2){
                                _this.create_tomcat_list(function(){
                                    layer.msg('修改完成',{icon:1});
                                });
                            }
                        });
                        type1 = false;
                    }else{
                        type1 = true;
                    }

                    if(type && type1){
                        layer.msg('项目未修改',{icon:0})
                    }
                },
                btn2:function(index,layero){
                    layer.close(index);
                }
            })
        },
        // 设置项目域名请求
        set_path_req:function(obj,callback){
            this.send({
                method:'ReplacePath',
                tips:'设置项目【'+ obj.domain +'】目录中，请稍后...',
                data:{domain:obj.domain,path:obj.path,version:obj.version},
                timeout:9999999,
                success:function(res){
                    layer.msg(res.msg,{icon:res.status?1:2});
                    if(!res.status) return false
                    if(callback) callback(res);
                }
            })
        },
        // 设置项目域名请求
        set_domain_req:function(obj,callback){
            this.send({
                method:'RenameDomain',
                tips:'设置项目【'+ obj.domain +'】域名中，请稍后...',
                data:{domain:obj.domain,domain2:obj.domain2,appbase:obj.appbase,version:obj.version,mapping:obj.mapping},
                timeout:999999,
                success:function(res){
                    layer.msg(res.msg,{icon:res.status?1:2});
                    if(!res.status) return false
                    if(callback) callback(res);
                }
            })
        },

        
       
        // 删除项目请求
        del_tomcat_req:function(obj){
            var _this = this;
            if(obj.domain == 'localhost'){
                layer.msg('默认项目不支持删除',{icon:2});
                return false;
            }
            SafeMessage('删除项目','是否删除该【 '+ obj.domain +' 】项目,是否继续?',function () {
                _this.send({
                    method:'DelProject',
                    tips:'正在删除项目,请稍后...',
                    data:{version:obj.version,domain:obj.domain},
                    timeout:9999999,
                    success:function(res){
                        layer.msg(res.msg,{icon:res.status?1:2});
                        _this.create_tomcat_list(function(ress){
                            layer.msg(res.msg,{icon:res.status?1:2});
                        });
                    }
                });
            });
        },
        // 添加tomcat项目请求
        add_tomcat_req:function(obj,callback){
            this.send({
                method:'AddProject',
                tips:'正在添加Tomcat项目，请稍后...',
                data:{domain:obj.domain,path:obj.path,version:obj.version},
                timeout:9999999,
                success:function(res){
                    layer.msg(res.msg,{icon:res.status?1:2});
                    if(callback) callback(res);
                }
            })
        },
        
        // 获取项目列表
        get_tomcat_site:function(callback){
            this.send({
                method:'GetSite',
                tips:'正在获取Tomcat项目列表,请稍后...',
                success:function(res){
                    if(res.status === false) layer.msg(res.msg,{icon:2});
                    if(callback) callback(res);
                }
            });
        },
        // 创建tomcat服务状态
        create_server_version:function(){
            var _this = this;
            this.get_server_version(function(res){
                var version_list = '';
                _this.version_list = res.msg;
                _this.server_version = {title:[],data:[]};
                for(var i in _this.version_list){
                    if(_this.version_list[i] !== false){
                        _this.server_version.title.push(i);
                        _this.server_version.data.push(_this.version_list[i]);
                    }
                }
                for(var j = 0; j < _this.server_version.title.length;j++){
                    var item_title =  _this.server_version.title[j],item_data =_this.server_version.data[j];
                    version_list += '<div class="box_item">'+
                        '<div class="box_title">'+ item_title +'服务</div>'+
                        '<div class="status"><div class="btn_item_block"><span>当前状态：'+ (item_data.status?'开启':'停止') +'</span><span style="color: '+ (item_data.status?'#20a53a':'red') +'; margin-left: 3px;" class="glyphicon '+ (item_data.status?'glyphicon-play':'glyphicon-pause') +'"></span></div><div class="btn_item_block"><span>端口：</span><span>'+ item_data.port +'<a href="javascript:;" class="btlink ml5" data-version="'+ item_title +'" onclick="tomcat.set_port_view({version:\''+ item_title +'\',port:\''+ item_data.port +'\'})">更改</a></span></div><div class="btn_item_block"><span>JDK版本：</span><span>'+item_data.jdk_version +'</span></div></div>'+
                        '<button type="button" class="btn btn-default btn-sm" onclick="tomcat.start_tomcat({version:\''+ item_title +'\',type:\''+ (item_data.status?'stop':'start') +'\'})">'+ (item_data.status?'停止':'启动') +'</button>'+
                        '<button type="button" class="btn btn-default btn-sm" onclick="tomcat.start_tomcat({version:\''+ item_title +'\',type:\'reload\'})">重载配置</button>'+
                        '</div>'
                }
                $('.version_box .soft-man-con').html(version_list);
            });
        },
        // 设置端口视图
        set_port_view:function(obj){
            var _this = this;
            layer.open({
                type: 1,
                closeBtn:2,
                title:'修改【'+ obj.version +'】端口',
                area: '400px', //宽高
                content:'<div class="bt_conter bt-form pd15 pb70" style="height:80px;width:100%;">\
                        <div class="line"><span class="tname">端口</span>\
                            <div class="info-r c4"><input class="bt-input-text" type="text" name="port" placeholder="请输入项目域名" value="'+ obj.port +'" style="width:200px"></div>\
                        </div>\
                    </div>',
                btn:['确定','取消'],
                yes:function(index,layero){
                    var port = $('[name="port"]').val();
                    _this.set_port_req({ version:obj.version,port:port },function(res){
                        layer.close(index);
                    });
                },
                btn2:function(index,layero){
                    layer.close(index);
                }
            })
        },
        // 获取服务状态
        get_server_version:function(callback){
            this.send({
                method:'TomcatVersion',
                tips:'正在获取服务状态，请稍后...',
                success:function(res){
                    if(res.status === false) layer.msg(res.msg,{icon:2});
                    if(callback) callback(res);
                }
            });
        },
        // 保存配置
        save_config_req:function(obj){
            this.send({
                method: 'WriteFile',
                data:{
                    data:obj.data,
                    path:obj.path,
                    encoding:obj.encoding
                },
                tips: '正在保存配置文件，请稍后<img src="/static/img/ing.gif">',
                success: function (res) {
                    layer.msg(res.msg, { icon: res.status?1:2 });
                }
            });
        },
        // 创建日志列表
        create_logs_list:function(callback){
            var _this = this;
            this.get_logs_req(function(res){
                var rdata = res.msg,option_list = '';
                _this.logs_list = {
                    title:[],
                    data:[],
                };
                for(var i in rdata){
                    if(rdata[i] !== false){
                        _this.logs_list.title.push(i);
                        _this.logs_list.data.push(rdata[i]);
                    }
                }
                for(var j = 0; j < _this.logs_list.title.length;j++){
                    option_list += '<option value="'+ j +'">'+_this.logs_list.title[j]+'</option>';
                }
                $('.tomcat_log').val(_this.logs_list.data[0]);
                $('.tomcat_version').html(option_list);
                $('.tomcat_version').change(function(){
                    $('.tomcat_log').val(_this.logs_list.data[$(this).val()]);
                    var ele = document.getElementsByClassName('tomcat_log')[1];
                    ele.scrollTop = ele.scrollHeight;
                });
                var ele = document.getElementsByClassName('tomcat_log')[1];
                 ele.scrollTop = ele.scrollHeight;
                if(callback) callback();
            });
        },
        
        // 创建配置文件编辑
        create_config_edit:function(callback){
            var _this = this;
            this.get_config_req(function(res){
                var rdata = res.msg,option_list = '';
                _this.config_list = {
                    title:[],
                    data:[],
                };
                console.log(rdata)
                for(var i in rdata){
                    if(rdata[i] !== false){
                        _this.config_list.title.push(i);
                        _this.config_list.data.push(rdata[i]);
                    }
                }
                for(var j = 0; j < _this.config_list.title.length;j++){
                    option_list += '<div class="bt_tab_index" data-index="'+ j +'">【'+_this.config_list.title[j]+'】配置文件</div>';
                }
                $('.config_box .bt_tab_list').html(option_list);
                $('.bt_tab_list .bt_tab_index').eq(0).addClass('active');
                $('.bt_tab_list .bt_tab_index').click(function(){
                    var index = $(this).attr('data-index');
                    $(this).addClass('active').siblings().removeClass('active');
                    $('#textBody').val(_this.config_list.data[index].data);
                    $('#textBody').parent().find('.CodeMirror').remove();
                    _this.edit_codeMirror = CodeMirror.fromTextArea(document.getElementById("textBody"), {
                        extraKeys: { "Ctrl-Space": "autocomplete" },
                        lineNumbers: true,
                        matchBrackets: true,
                    });
                });
                for(var z = 0;z<_this.config_list.data.length;z++){
                    if(_this.config_list.data[z].status){
                        $('#textBody').val(_this.config_list.data[0].data);
                    }
                }
                $('#textBody').parent().find('.CodeMirror').remove();
                _this.edit_codeMirror = CodeMirror.fromTextArea(document.getElementById("textBody"), {
                    extraKeys: { "Ctrl-Space": "autocomplete" },
                    lineNumbers: true,
                    matchBrackets: true,
                });
            });
        },
        // 获取配置文件请求
        get_config_req:function(callback){
            this.send({
                method: 'GetConfig',
                tips: '正在获取配置文件，请稍后<img src="/static/img/ing.gif">',
                success: function (res) {
                    if(res.status === false) {
                        layer.msg(res.msg, { icon: 2 });
                        return false;
                    }
                    if(callback) callback(res);
                }
            });
        },
        
        // 获取日志请求
        get_logs_req:function(callback) {
            this.send({
                method: 'GetOpeLogs',
                tips: '正在获取日志，请稍后<img src="/static/img/ing.gif">',
                success: function (res) {
                    if(res.status === false) {
                        layer.msg(res.msg, { icon: 2 });
                        return false;
                    }
                    if(callback) callback(res);
                }
            });
        },
        
        // 发送请求封装
        send: function (obj) {
            var loadT = '';
            if (obj.load == undefined) obj.load = 0
            if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this.plugin_name
            if (!obj.plugin_name || !obj.method) {
                layer.msg('插件类名称，或插件方法名称缺失!', {
                    icon: 2
                });
                return false;
            }
            if (obj.load === 0) {
                loadT = layer.msg(obj.tips, {
                    icon: 16,
                    time: 0,
                    shade: 0.3
                });
                console.log(obj.load,'h');
            } else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
                loadT = layer.load();
                console.log(obj.load,'d');
            }
            // console.log(obj.load);
            $.ajax({
                type: 'POST',
                url: '/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method,
                data: obj.data || {},
                timeout: obj.timeout || 99999999,
                complete: function (res) {
                    if (obj.load === 0 || obj.load === 1) layer.close(loadT);
                },
                success: function (rdata) {
                    if (!obj.success) {
                        layer.msg(rdata.msg, {
                            icon: rdata.status ? 1 : 2
                        });
                        return;
                    }
                    obj.success(rdata);
                },
                error: function (ex) {
                    if (!obj.error) {
                        layer.msg('请求过程发现错误!', {
                            icon: 2
                        });
                        return;
                    }
                    return obj.error(ex);
                }
            });
        }
    }
    tomcat.init();
</script>